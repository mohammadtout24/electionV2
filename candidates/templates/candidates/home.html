<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>صفحة التصويت</title>
<style>
/* Existing styles */
body {
    font-family: "Cairo", "Tahoma", sans-serif;
    background-color: #f0f4f8;
    direction: rtl;
    padding: 20px;
    /* Adjusted padding-top to accommodate the single-line header below */
    padding-top: 70px; 
    line-height: 1.5;
}

.container {
    max-width: 780px;
    margin: 0 auto;
    background: #fff;
    padding: 15px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

/* Fixed Header Bar (General cleanup) */
.fixed-actions-bar {
    position: fixed;
    top: 0; right: 0; left: 0;
    z-index: 1000;
    background-color: #f0f4f8;
    padding: 4px 0;
    text-align: center;
}
.fixed-actions-content {
    max-width: 780px;
    margin: 0 auto;
    display: flex;
    flex-wrap: wrap; 
    align-items: center;
    justify-content: space-between;
    padding: 4px 15px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}
h4 {
    color: #10A3D6;
    margin: 0;
    font-size: 1.05em;
    font-weight: 700;
    flex-basis: 25%; 
    text-align: right;
}
.login-link {
    flex-basis: 25%; 
    text-align: left; 
}
.login-link a {
    color: #10A3D6;
    font-weight: 600;
    text-decoration: none;
}
.login-link a:hover { text-decoration: underline; }

.fixed-buttons-container {
    display: flex;
    flex-direction: row; 
    gap: 6px;
    justify-content: center; 
    flex-basis: 50%; 
    flex-grow: 1; 
    order: 0; 
    padding: 4px 0; 
}

/* New combined container for the submit action */
.fixed-action-row {
    width: 100%; /* Take full width below the main header row */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding-top: 5px;
    border-top: 1px dashed #e9ecef;
    order: 1; 
}
.fixed-action-row p {
    margin: 0;
    font-size: 0.85em;
    font-weight: 600;
    color: #555;
    flex-shrink: 1;
}


/* Candidate Card */
.candidate-card {
    background: #f9fbfc;
    padding: 6px 8px; 
    border-radius: 8px;
    border-right: 3px solid #10A3D6;
    margin-bottom: 6px;
    display: flex;
    flex-direction: column;
    transition: background 0.3s, border-color 0.3s;
}
.candidate-card.selected {
    background: #e8f6ff;
    border-color: #0d6efd;
}
.candidate-card:hover { background: #e8f6ff; }

/* Radio + title line */
.radio-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 4px;
    font-size: 0.85em;
    font-weight: bold;
    color: #333;
    margin-bottom: 4px;
}
.radio-topic-wrapper {
    display: flex;
    align-items: center;
    gap: 4px;
}
.radio-top input[type="radio"] {
    transform: scale(0.95);
}

/* Candidate inner content */
.candidate-inner {
    display: flex;
    flex-direction: row-reverse;
    align-items: stretch; 
    gap: 6px;
}
/* Ensure the link around the image also stretches */
.candidate-inner a {
    height: 100%;
    flex-shrink: 0;
}
.candidate-photo {
    width: 90px; 
    height: 100%; 
    border-radius: 4px;
    border: 1px solid #10A3D6;
    object-fit: cover; 
    flex-shrink: 0;
}


.candidate-info {
    flex-grow: 1;
    text-align: right;
}
.candidate-info strong {
    display: block;
    font-size: 1em;
    color: black;
    margin-bottom: 0;
}

/* Bio summary + Read more inline */
.bio-summary-wrapper {
    display: block;
    text-align: right;
    margin-top: 2px;
}
.bio-summary {
    display: inline;
    max-width: calc(100% - 95px); 
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    vertical-align: middle;
}
.read-more-btn {
    display: inline;
    margin-left: 4px;
    background: none;
    color: #10A3D6;
    border: none;
    cursor: pointer;
    font-size: 0.8em;
    font-weight: bold;
    padding: 0;
    text-decoration: underline;
}
.read-more-btn:hover { color: #0d6efd; }

/* Expanded description */
.candidate-description-wrapper {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease-out;
    margin-top: 2px;
}
.candidate-description-wrapper.expanded {
    max-height: 1000px;
}
.candidate-description {
    padding-top: 4px;
    border-top: 1px dashed #e9ecef;
    font-size: 0.85em;
    line-height: 1.4;
    white-space: normal;
}

/* General Buttons (Default is #10A3D6 for results/voter lists) */
.vote-btn, .results-btn {
    background-color: #10A3D6; 
    color: #fff;
    border: none;
    border-radius: 5px;
    padding: 4px 10px;
    font-size: 0.8em;
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s;
    text-decoration: none; 
}
.vote-btn:hover, .results-btn:hover {
    background-color: #0c82ab;
    transform: scale(1.03);
}

/* --- START: CUSTOM VOTE BUTTON STYLING (For Header Button) --- */
/* Override default color for the main submit vote button */
#submit-vote-btn {
    background-color: #00A995; 
    min-width: 150px; 
    flex-shrink: 0;
}
#submit-vote-btn:hover {
    background-color: #008878; 
    transform: scale(1.03);
}
/* Button to look "selected" or "voted" (This state keeps the green for user feedback) */
.vote-btn.selected-vote {
    background-color: #28a745;
}
.vote-btn.selected-vote:hover {
    background-color: #1e7e34;
}
/* --- END: CUSTOM VOTE BUTTON STYLING --- */


/* Results specific styles (UPDATED FOR VISUALISATION) */
.results-heading {
    color: #10A3D6;
    font-size: 1.5em;
    border-bottom: 2px solid #10A3D6;
    padding-bottom: 5px;
    margin-bottom: 15px;
    text-align: right;
}
.result-card {
    background: #f0f8ff;
    padding: 10px 15px;
    border-radius: 8px;
    border-left: 5px solid #10A3D6;
    margin-bottom: 10px;
    display: flex;
    flex-direction: column; 
    gap: 8px;
    font-size: 1.1em;
}
.result-card strong {
    color: #333;
    display: block; 
    text-align: right;
}
.result-visualisation {
    display: flex;
    align-items: center;
    gap: 10px;
    direction: ltr; 
}
.vote-count {
    background-color: #10A3D6;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    min-width: 40px;
    text-align: center;
    font-size: 1.1em;
    font-weight: 700;
    flex-shrink: 0; 
}
.progress-container {
    flex-grow: 1;
    background-color: #e9ecef;
    border-radius: 4px;
    height: 25px;
    overflow: hidden;
}
.progress-bar {
    height: 100%;
    background-color: #28a745; 
    transition: width 0.5s ease-in-out;
    text-align: left;
}


/* Messages */
.message, .warning {
    padding: 6px 10px;
    border-radius: 6px;
    margin-bottom: 10px;
    font-size: 0.9em;
}
.message {
    background: #d1e7dd;
    color: #0f5132;
}
.warning {
    background: #f8d7da;
    color: #842029;
}

/* Mobile tweaks */
@media (max-width: 768px) { 
    /* Increased body padding top for the two stacked rows (buttons + action row) */
    body { 
        padding: 10px; 
        padding-top: 160px; 
    }
    .fixed-actions-content { 
        flex-direction: column; 
        gap: 6px; 
        padding: 6px 10px; 
    }
    h4, .login-link {
        margin-bottom: 4px; 
        flex-basis: 100%; 
        text-align: center; 
    }
    .fixed-buttons-container { 
        flex-direction: row; 
        width: 100%; 
        justify-content: center; 
        order: 1; 
    }
    
    /* Mobile stacking for the action row */
    .fixed-action-row {
        flex-direction: column; /* Stack button and text vertically */
        padding-top: 10px;
        order: 2; 
    }
    .fixed-action-row p {
        order: 1; /* Place text above the button on mobile */
        margin-bottom: 8px;
    }
    .fixed-action-row button {
        order: 2;
    }

    .fixed-buttons-container .vote-btn,
    .fixed-action-row button {
        width: 100%;
        max-width: 250px; 
    }

    .candidate-inner { 
        flex-direction: column-reverse; 
        align-items: center; 
        gap: 15px; 
        padding-bottom: 4px;
    }
    .candidate-photo { 
        width: 140px; 
        height: auto; 
        max-height: 160px; 
    }
    .candidate-inner a {
        height: auto; 
        width: 140px; 
    }
    .candidate-info { 
        text-align: center; 
        padding: 0 5px; 
    }
    .candidate-info strong {
        font-size: 1.1em; 
    }
    .bio-summary-wrapper { 
        text-align: center; 
        margin-top: 4px;
    }
    .bio-summary { 
        white-space: normal; 
        max-width: 100%;
        text-overflow: clip; 
        display: block; 
        overflow: visible;
        font-size: 0.9em; 
    }
    .read-more-btn { 
        display: block; 
        text-align: center;
        margin-top: 5px;
    }
}
</style>
</head>
<body>

<div class="fixed-actions-bar">
    <div class="fixed-actions-content">
        <h4>المشاريع</h4>
        
        {# Container for the two side-by-side buttons #}
        <div class="fixed-buttons-container">
            {% if user.is_authenticated and not is_admin %}
                {% if is_candidate %}
                    <a href="{% url 'candidate_results' %}" class="vote-btn results-btn">النتائج</a>
                {% endif %}
                {% if user.candidate %}
                    <a href="{% url 'all_users' %}" class="vote-btn">قائمة الناخبين</a>
                {% endif %}
            {% endif %}
        </div>

        <div class="login-link">
            {% if user.is_authenticated %}
                <a href="{% url 'logout' %}">تسجيل الخروج</a>
            {% else %}
                <a href="{% url 'login' %}">تسجيل دخول المرشح</a>
            {% endif %}
        </div>
        
        {# NEW: Combined action row for button and description #}
        {% if not is_admin and not voting_closed %}
            <div class="fixed-action-row">
                <p>اختر مشروعك المفضل، ثم اضغط هنا </p>
                <button type="submit" 
                        id="submit-vote-btn" 
                        class="vote-btn" 
                        form="main-vote-form">
                    تصويت
                </button>
            </div>
        {% endif %}

    </div>
</div>

<div class="container">
    {% if messages %}
        {% for message in messages %}
            <div class="message">{{ message }}</div>
        {% endfor %}
    {% endif %}

    {% if is_admin %}
        <h2 class="results-heading">نتائج التصويت الإجمالية (مرتبة حسب عدد الأصوات)</h2>
        {% if candidates_with_votes %}
            {% for item in candidates_with_votes %}
                <div class="result-card">
                    {{ item.candidate.name }} - {{ item.candidate.topic }}
                    <div class="result-visualisation">
                        <span class="vote-count">{{ item.vote_count }}</span>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: {% widthratio item.vote_count max_votes 100 %}%;"></div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p style="text-align:right;">لا توجد أصوات أو مرشحين لعرض النتائج.</p>
        {% endif %}

    {% else %}
        {% if voting_closed %}
            <div class="warning">
                انتهت فترة التصويت. لم يعد بالإمكان التصويت أو تعديل الأصوات بعد {{ deadline }}.
            </div>
        {% else %}
            {% if has_voted and voted_for_name %}
                <p><strong>لقد أدليت بصوتك سابقاً لصالح {{ voted_for_name }}. يمكنك تحديث اختيارك أدناه حتى {{ deadline }}:</strong></p>
            {% endif %}
        {% endif %}

        {# RESTORED: Single form wrapping all candidates #}
        <form method="POST" action="{% url 'submit_vote' %}" id="main-vote-form">
            {% csrf_token %}
            {% if candidates_with_votes %}
                {% for item in candidates_with_votes %}
                    <div class="candidate-card {% if item.candidate.id == voted_candidate_id %}selected{% endif %}" data-candidate-id="{{ item.candidate.id }}">
                        <div class="radio-top">
                            <div class="radio-topic-wrapper">
                                <input type="radio" name="selected_candidate"
                                    value="{{ item.candidate.id }}"
                                    id="candidate{{ item.candidate.id }}"
                                    {% if item.candidate.id == voted_candidate_id %}checked{% endif %}
                                    {% if voting_closed %}disabled{% endif %}
                                    {# CRITICAL FIX: Adding 'required' prevents the empty POST request causing the 404 #}
                                    required>
                                <span>صوت لهذا المشروع: {{ item.candidate.topic }}</span>
                            </div>
                            {# REMOVED: Card-specific button is gone #}
                        </div>
                        <label for="candidate{{ item.candidate.id }}" class="candidate-inner">
                            <a href="{% url 'candidate_detail' item.candidate.id %}" style="text-decoration:none;">
                                {% if item.candidate.image %}
                                    <img src="{{ item.candidate.image.url }}" alt="{{ item.candidate.name }}" class="candidate-photo">
                                {% endif %}
                            </a>
                            <div class="candidate-info">
                                {{ item.candidate.name }}
                                <div class="bio-summary-wrapper">
                                    <span class="bio-summary">
                                        {{ item.candidate.description|striptags|truncatechars:80|safe }}
                                    </span>
                                    <button type="button" class="read-more-btn"
                                            id="read-more-btn-{{ item.candidate.id }}"
                                            onclick="toggleReadMore('description-wrapper-{{ item.candidate.id }}', this)">
                                        اقرأ المزيد
                                    </button>
                                </div>
                                <div id="description-wrapper-{{ item.candidate.id }}" class="candidate-description-wrapper">
                                    <div class="candidate-description">
                                        {{ item.candidate.description|safe }}
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>
                {% endfor %}
            {% else %}
                <p style="text-align:right;">لم يتم تسجيل مرشحين بعد.</p>
            {% endif %}
        </form>
    {% endif %}
</div>

<script>
function toggleReadMore(wrapperId, button) {
    const wrapper = document.getElementById(wrapperId);
    const summary = button.previousElementSibling;

    if (wrapper.classList.contains('expanded')) {
        wrapper.classList.remove('expanded');
        button.textContent = 'اقرأ المزيد';
        
        // Restore mobile/desktop summary visibility based on screen size
        if (window.innerWidth <= 768) {
             summary.style.display = 'block';
        } else {
             summary.style.display = 'inline';
        }
    } else {
        wrapper.classList.add('expanded');
        button.textContent = 'إخفاء التفاصيل';
        summary.style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Hide 'Read More' button if description is empty
    document.querySelectorAll('.read-more-btn').forEach(button => {
        const wrapperId = button.id.replace('read-more-btn-', 'description-wrapper-');
        const wrapper = document.getElementById(wrapperId);
        if (wrapper && wrapper.querySelector('.candidate-description').textContent.trim() === "") {
            button.closest('.bio-summary-wrapper').style.display = 'none';
        }
    });

    function updateVoteButtonAndCard() {
        // NOTE: This logic assumes your Django view is now correctly looking for request.POST.get('selected_candidate')
        const votedCandidateId = '{{ voted_candidate_id }}'; 
        const submitButton = document.getElementById('submit-vote-btn');
        let checkedRadio = document.querySelector('input[name="selected_candidate"]:checked');
        
        document.querySelectorAll('.candidate-card').forEach(card => card.classList.remove('selected'));

        if (checkedRadio) {
            const candidateId = checkedRadio.value;
            const selectedCard = checkedRadio.closest('.candidate-card');
            
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }

            if (submitButton) {
                if (candidateId === votedCandidateId) {
                    submitButton.textContent ="تصويت";
                    submitButton.classList.add('selected-vote');
                    submitButton.disabled = false;
                } else {
                    submitButton.textContent = 'تصويت';
                    submitButton.classList.remove('selected-vote');
                    submitButton.disabled = false;
                }
            }
        } else if (submitButton) {
            submitButton.textContent = 'تصويت';
            submitButton.classList.remove('selected-vote');
            // button is enabled by default, but the 'required' attribute on the radio will stop submission if nothing is checked
        }
    }

    // Call on load to set initial state
    updateVoteButtonAndCard();

    // Attach listener to radio buttons
    document.querySelectorAll('input[name="selected_candidate"]').forEach(radio => {
        if (!radio.disabled) {
            radio.addEventListener('change', updateVoteButtonAndCard);
        }
    });
    
    // Attach listener to card content area
    document.querySelectorAll('.candidate-inner').forEach(label => {
        label.addEventListener('click', function(event) {
            // Prevent toggling the radio if the read-more button was clicked
            if (event.target.classList.contains('read-more-btn')) {
                return;
            }

            const radio = this.closest('.candidate-card').querySelector('input[type="radio"]');
            if (radio && !radio.disabled) {
                radio.checked = true;
                setTimeout(updateVoteButtonAndCard, 0); 
            }
        });
    });
});
</script>
</body>
</html>
